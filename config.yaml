log:
  level: warn

# driven from CLI
mode: "" # one of "update", "publish"

helm:
  srcDir: "charts"
  targetDir: "target"
  lintK8s: "1.30.0"
  remote: "oci://ghcr.io/kiemlicz/charter"

pr:
  repo: "charter"
  owner: "kiemlicz"
  authToken: "" # GH_TOKEN can be used instead
  defaultBranch: "master"
  title: "Automated Chart generation: %s"
  body: "This is an automated PR updating the Helm charts from configured remotes."

githubReleases:
  - owner: "kubevirt"
    repo: "kubevirt"
    assets:
      - "kubevirt-operator.yaml"
      - "kubevirt-cr.yaml"
    chartName: "kubevirt"
    drop:
      - namespace
      - namespaces
    modifications:
      #      - expression: '.metadata.name |= "{{ include \"kubevirt.fullname\" . }}"' # not (yet?) extracting to different name
      - expression: '.metadata.namespace |= "{{ .Release.Namespace }}"'
        reject: "ClusterRole|ClusterRoleBinding|PriorityClass|CustomResourceDefinition"
      - expression: '(.subjects[] | select(.name == "kubevirt-operator") .namespace) = "{{ .Release.Namespace }}"'
        kind: "RoleBinding|ClusterRoleBinding"
      - expression: '.spec.configuration |= "{{ .Values.kubevirt.configuration | toYaml | nindent 8 }}"'
        kind: KubeVirt
        valuesSelector: ".spec.configuration"
      - expression: '.spec.certificateRotateStrategy |= "{{ .Values.kubevirt.certificateRotateStrategy | toYaml | nindent 8 }}"'
        kind: KubeVirt
        valuesSelector: ".spec.certificateRotateStrategy"
      - expression: '.spec.customizeComponents |= "{{ .Values.kubevirt.customizeComponents | toYaml | nindent 8 }}"'
        kind: KubeVirt
        valuesSelector: ".spec.customizeComponents"
      - expression: '.spec.workloadUpdateStrategy |= "{{ .Values.kubevirt.workloadUpdateStrategy | toYaml | nindent 8 }}"'
        kind: KubeVirt
        valuesSelector: ".spec.workloadUpdateStrategy"
      - expression: '.metadata.annotations |= "{{ .Values.annotations | toYaml | nindent 8 }}"'
        kind: CustomResourceDefinition
        valuesSelector: ".metadata.annotations"
      - expression: '.spec.replicas |= "{{ .Values.kubevirtOperator.replicas }}"'
        kind: Deployment
        valuesSelector: ".spec.replicas"
    addCrdValues: # content must be lowercase due to https://github.com/spf13/viper/issues/373
      annotations:
        "helm.sh/resource-policy": "keep"
  - owner: "kubevirt"
    repo: "containerized-data-importer"
    assets:
      - "cdi-operator.yaml"
      - "cdi-cr.yaml"
    chartName: "cdi"
    drop:
      - namespace
      - namespaces
    modifications:
      #      - expression: '.metadata.name |= "{{ include \"cdi.fullname\" . }}"' # not (yet?) extracting to different name
      - expression: '.metadata.namespace |= "{{ .Release.Namespace }}"'
        reject: "ClusterRole|ClusterRoleBinding|PriorityClass|CustomResourceDefinition"
      - expression: '(.subjects[] | select(.name == "cdi-operator") .namespace) = "{{ .Release.Namespace }}"'
        kind: "RoleBinding|ClusterRoleBinding"
      - expression: '.spec.config |= "{{ .Values.cdi.config | toYaml | nindent 8 }}"'
        kind: CDI
        valuesSelector: ".spec.config"
      - expression: '.spec.infra |= "{{ .Values.cdi.infra | toYaml | nindent 8 }}"'
        kind: CDI
        valuesSelector: ".spec.infra"
      - expression: '.spec.workload |= "{{ .Values.cdi.workload | toYaml | nindent 8 }}"'
        kind: CDI
        valuesSelector: ".spec.workload"
      - expression: '.metadata.annotations |= "{{ .Values.annotations | toYaml | nindent 8 }}"'
        kind: CustomResourceDefinition
        valuesSelector: ".metadata.annotations"
      - expression: '.spec.replicas |= "{{ .Values.cdiOperator.replicas }}"'
        kind: Deployment
        valuesSelector: ".spec.replicas"
    addCrdValues: # content must be lowercase due to https://github.com/spf13/viper/issues/373
      annotations:
          "helm.sh/resource-policy": "keep"
